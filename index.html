<!DOCTYPE html>

<html>

<head>

<title>Matrizes</title>

<script>

var howMany = 0;

function buildContainers(){
	
	clearResult();

	howMany = parseInt(document.getElementById("quantas-matrizes").value);
	var mainContainer = document.getElementById("matrizes");
	var matrixesContainersStr = "";
	var counter = 0;
	
	while(counter < howMany){
		matrixesContainersStr += "<div id='mat-" + counter + "-cont'>"
					+"<u>Matriz " + (counter + 1) + "</u></br>"
					+"<label>i,j: </label><input type='text' maxlength='4' size='4' id='mat-" + counter + "-dimensions' onchange='setMatrixDimensions(this, " + counter + ")'>. "
					+"<label>N de opera&ccedil;&otilde;es: </label>"
					+"<input type='text' maxlength='4' size='4' id='mat-" + counter + "-howmany-opts' onchange='setOperations(this, " + counter + ")'>."
					+"<div id='mat-" + counter + "-opts' ></div>"
					+"<div id='mat-" + counter + "'></div>"
					+"</div>";

		if (counter != howMany-1)
			matrixesContainersStr += "</br>"
						+"<select id='operation" + counter + "'>"
						+"<option value='sum'>&#43;</option>"
						+"<option value='subtract'>&minus;</option>"
						+"<option value='multiply'>&times;</option>"
						+"</select>";
			
		counter++;
		
	}

	mainContainer.innerHTML = matrixesContainersStr;

}

function setMatrixDimensions(dimensionsElement, matrIndex){

	var x = dimensionsElement.value.split(',')[0];
	var y = dimensionsElement.value.split(',')[1];
	var i = 0;
	var j = 0;
	var matrixStr = "";

	for(;i < x;i++)
		for(j = 0;j < y;j++){
			matrixStr += "<input type='text' maxlength='4' size='4' id='mat-" + matrIndex + "-" + i + "-" + j + "'>";
			if (j == y-1) matrixStr += "</br>";
		}

	document.getElementById("mat-"+matrIndex).innerHTML = matrixStr;

}

function setOperations(howmanyElement, matrIndex){
	
	var howmanyOperations = parseInt(howmanyElement.value);
	var i = 0;
	var matrixStr = "";

	for(;i < howmanyOperations;i++)
		matrixStr += "<select id='mat-" + matrIndex + "-opt-" + i + "' onchange='changedOperation(this, " + matrIndex + ", " + i + ")' >"
				+"<option value=''></option>"
				+"<option value='invert'>inversa</option>"
				+"<option value='transpose'>transposta</option>"
				+"<option value='scale'>mult. escalar</option>"
				+"<option value='power'>potencia</option>"
				+(howMany == 1 ? ("<option value='determine'>determinante</option>"
				+"<option value='gaussJordanElimination'>sistema linear</option>") : "")
				+"</select>"
				+"<div id='mat-" + matrIndex + "-opt-" + i + "-textfield' ></div>";

	document.getElementById("mat-"+matrIndex+"-opts").innerHTML = matrixStr;
	
}

function changedOperation(selectElement, matrIndex, i){

	var optTextfield = "";

	if(selectElement.value=="scale" || selectElement.value=="power")
		optTextfield = "<input type='text' maxlength='4' size='4' id='mat-" + matrIndex + "-opt-"+ i +"-textfield-field'>";
	else
		optTextfield = "";

	document.getElementById("mat-" + matrIndex + "-opt-" + i + "-textfield").innerHTML = optTextfield;
	
}

function domToArray(){

	var matrixes = [];
	var matrix = [];
	var counter = 0;
	
	while(counter < howMany){
		matrix = [];
		var x = document.getElementById("mat-" + counter + "-dimensions").value.split(',')[0];
		var y = document.getElementById("mat-" + counter + "-dimensions").value.split(',')[1];
		var i = 0;
		var j;
		for(;i<x;i++){
			matrix[i] = [];
			for(j = 0;j < y;j++)
				matrix[i][j] = eval(document.getElementById( "mat-" + counter + "-" + i + "-" + j ).value);
		}
		counter++;

		matrixes.push(matrix);
	}
	
	return matrixes;
	
}

function sum(A, B){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var res = [];

	for(;i < x;i++){
		res[i] = [];
		for(j = 0;j < y;j++)
			res[i][j] = A[i][j] + B[i][j];
	}
	
	return res;

}

function subtract(A, B){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var res = [];

	for(;i < x;i++){
		res[i] = [];
		for(j = 0;j < y;j++)
			res[i][j] = A[i][j] - B[i][j];

	}
	
	return res;

}

function multiply(A, B){

	var x = A.length;
	var y = B[0].length;
	var i = 0;
	var line = 0;
	var column = 0;
	var resPart = 0;
	var res = [];

	while(line < x){
		res[line] = [];
		while(column < y){
			resPart = 0;
			for(i = 0;i < x;i++){
				if(A[line][i] == 0 || B[i][column] == 0){
					resPart = 0;
					break;
				}
				resPart += A[line][i] * B[i][column];
			}
			res[line][column++] = resPart;
		}
		column = 0;
		line++;
	}
	
	return res;

}

function scale(A, s){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var res = [];

	for(;i < x;i++){
		res[i] = [];
		for(j = 0;j < y;j++)
			res[i][j] = A[i][j] * s;

	}
	
	return res;

}

function invert(A){

	if(determine(A) == 0) return false;

	return scale(adjugate(A), 1/determine(A));

}

function adjugate(A){

	return transpose(cofactor(A));

}

function cofactor(A){

	var x = A.length;
	var i = 0;
	var j = 0;
	var res = [];

	for(;i < x;i++){
		res[i] = [];
		for(j = 0;j < x;j++)
			res[i][j] = _cofactor(A, i, j);
	}

	return res;

}

function _cofactor(A, w, z){

	return minor(A, w, z) * ((w + z) % 2 == 0? 1 : -1);

}

function minor(A, w, z){

	return determine(submatrix(A, w, z));

}

function submatrix(A, w, z){

	var x = A.length;
	var i = 0;
	var j = 0;
	var m = 0;
	var n = 0;
	var res = [];

	for(;i < x;i++){
		for(j = 0;j < x;j++){
			if(i == w || j == z)
				continue;

			m = i > w ? i - 1 : i;
			n = j > z ? j - 1 : j;

			if(typeof res[m] === "undefined") res[m] = [];
				
			res[m][n] = A[i][j];
		}

	}

	return res;

}

function transpose(A){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var res = [];

	for(;i < x;i++)
		for(j = 0;j < y;j++){
			if (i == 0) res[j] = [];
			res[j][i] = A[i][j];
		}
	
	return res;

}

function chioClosestToOne(A){

	var x = A.length;
	var i = 0;
	var j = 0;
	var closest = { "i": 0, "j": 0 };

	for(;i < x;i++)
		for(j = 0;j < x;j++)
			if(A[i][j] == 1)
				return { "i": i, "j": j };
			else if(A[i][j] != 0 && Math.abs(A[i][j] - 1) < Math.abs(A[closest.i][closest.j] - 1))
				closest = { "i": i, "j": j };
	
	return closest;

}

function chioGetB(A, cT1){

	var x = A.length;
	var i = 0;
	var j = 0;
	var m = 0;
	var n = 0;
	var B = [];

	for(;i < x;i++)
		for(j = 0;j < x;j++){
			if(i == cT1.i || j == cT1.j)
				continue;

			m = i > cT1.i ? i - 1 : i;
			n = j > cT1.j ? j - 1 : j;

			if(typeof B[m] === "undefined") B[m] = [];
				
			B[m][n] = A[i][j] - A[i][cT1.j] * A[cT1.i][j];
		}

	return B;

}

function chioDet(A){

	if (A.length == 1) return A[0][0];

	var closestTo1 = chioClosestToOne(A);
	var B = chioGetB(A, closestTo1);
	var jok;

	if(A[closestTo1.i][closestTo1.j] == 1)
		jok = ( closestTo1.i + closestTo1.j ) % 2 == 0 ? 1 : -1;
	else
 		jok = 1;

	return chioDet(B) * jok;

}

function determine(A){

	return chioDet(A);

}

function power(A, p){

	if (p == 1) return A;

	var res = A;

	while(p-- > 1)
		res = multiply(res, A);
	
	return res;

}

function gaussJordanElimination(A){

	return reducedRowEchelonForm(rowEchelonForm(A));

}

function rowEchelonForm(A){

	var x = A.length;
	var y = A[0].length - 1;
	var i = 0;
	var j = 0;
	var res = A;

	for(;i < x;i++)
		for(j = 0;j < y;j++)
			if (i > j && res[i][j] !== 0 || (res[i][j] == 0 && i == j)){
				if (isRowEchelonForm(res))
					return res;

				res = elementaryOperations(res, i, j, true);				
			}
	
	return res;

}

function reducedRowEchelonForm(A){

	var x = A.length;
	var i = 0;
	var h;
	var res = A;
	var zeros = getLeadingZeros(A);

	for(;i < x;i++)
		if(zeros[i] && zeros[i] < x && !loneInColumn(res, i, zeros[i]))
			for(h = zeros[i] - 1;h >= 0;h--){
				if(isReducedRowEchelonForm(res))
					return res;

				if(res[h][zeros[i]] && zeros[i] != x)
					res = elementaryOperations(res, h, zeros[i], false);
			}

	return res;

}

function isRowEchelonForm(A){
	
	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var jLeadAbove = 0;
	var consecutiveZeros;
	var zeros = getLeadingZeros(A)

	for(i = 0;i < x - 1;i++){
		if(zeros[i] > zeros[i + 1]) return false;
		if(zeros[i] != x)
			for(j = 0;j < y;j++){
				if(j == 0 && A[i][j] == 0) consecutiveZeros = true;
				if(A[i][j] != 0 && j <= jLeadAbove) return false;
				if(A[i][j] != 0 && consecutiveZeros){
					jLeadAbove = j;
					consecutiveZeros = false;
					break;
				}
			}

	}

	return true;
	
}

function isReducedRowEchelonForm(A){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var consecutiveZeros = false;

	for(i = 0;i < x;i++){
		for(j = 0;j < y;j++){
			if(j == 0 && A[i][j] == 0) consecutiveZeros = true;
			if(A[i][j] != 0 && consecutiveZeros && (A[i][j] != 1 || !loneInColumn(A, i, j))) return false;
			if(A[i][j] != 0 && consecutiveZeros){
				consecutiveZeros = false;
				break;
			}
		}
	}

	return true;

}

function loneInColumn(A, i, j){
	
	var h = 0;
	var x = A.length;

	for(;h < x;h++)
		if(h != i && A[h][j] != 0) return false;

	return true;

}

function elementaryOperations(A, i, j, ref){

	var res = A;
	var iNonZero = findNonZero(res, i, j, ref);
	var expr;
	var GCFRes;
	var LCMRes;
	var resijinozeroj;

	if(res[i][j] == 0 && i == j){

		if(res[i][j] == 0 && i == j){
			res = switchLines(res, i, j, !ref);
			console.log("expr: ", "switchLines" , "; result: ", JSON.stringify(res), "; i: ", i, "; j: ", j);
			return res;
		}

	}else while(res[i][j] || i == j){

		expr = "";
		
		GCFRes = GCF(res[i][j], res[iNonZero][j]);
		LCMRes = Math.abs(res[i][j] * res[iNonZero][j]) / GCFRes;
		resijinozeroj = Math.abs(res[i][j]/res[iNonZero][j]);

		if(res[i][j] + res[iNonZero][j] === 0)
			expr = "res[i][j] + res[iNonZero][j]";
		else if(res[i][j] - res[iNonZero][j] === 0)
			expr = "res[i][j] - res[iNonZero][j]";
		else if(res[i][j] * GCFRes + res[iNonZero][j] === 0 || 
					res[i][j] * GCFRes - res[iNonZero][j] === 0)
			expr = "res[i][j] * " + GCFRes;			
		else if(res[i][j] + res[iNonZero][j] * LCMRes === 0) 
			expr = "res[i][j] + res[iNonZero][j] * " + LCMRes;
		else if(res[i][j] - res[iNonZero][j] * LCMRes === 0)      
			expr = "res[i][j] - res[iNonZero][j] * " + LCMRes;
		else if(res[i][j] + resijinozeroj * res[iNonZero][j] === 0)
			expr = "res[i][j] + " + resijinozeroj + " * res[iNonZero][j]";
		else if(res[i][j] - resijinozeroj * res[iNonZero][j] === 0)
			expr = "res[i][j] - " + resijinozeroj + " * res[iNonZero][j]";
		else if(ref){
			res = switchLinesRowEchelonForm(res);
			console.log("expr: ", "switchLinesRowEchelonForm", "; result: ", JSON.stringify(res), "; iNonZero: ", iNonZero, "; i: ", i, "; j: ", j);
		}

		if (expr) {
			res = applyExpressionToRow(res, i, iNonZero, expr);
			console.log("expr: ", expr , "; result: ", JSON.stringify(res), "; iNonZero: ", iNonZero, "; i: ", i, "; j: ", j);
		}

		if((ref && isRowEchelonForm(A)) || (!ref && isReducedRowEchelonForm(A)))
			return res;

	}
	
	return res;

}

function switchLinesRowEchelonForm(A){
	
	return quickSwitchLines(getLeadingZeros(A), A);
	
}

function getLeadingZeros(A){

	var x = A.length;
	var y = A[0].length;
	var i = 0;
	var j = 0;
	var consecutiveZeros;
	var zeros = [];

	for(;i < x;i++)
		for(zeros[i] = 0, j = 0;j < y;j++){
			if(j == 0 && A[i][j] == 0) consecutiveZeros = true;
			if(A[i][j] == 0 && consecutiveZeros){ zeros[i] = zeros[i]? zeros[i] + 1 : 1; }
			if(A[i][j] != 0 && consecutiveZeros){ consecutiveZeros = false; break; }
		}

	return zeros;

}

function quickSwitchLines(items, items2, left, right) {

    var index;

    if (items.length > 1) {

        left = typeof left != "number" ? 0 : left;
        right = typeof right != "number" ? items.length - 1 : right;

        index = partition2(items, items2, left, right);

        if (left < index - 1) 
            quickSwitchLines(items, items2, left, index - 1);

        if (index < right)
            quickSwitchLines(items, items2, index, right);

    }

    return items2;

}

function partition2(items, items2, left, right) {

	var pivot = items[Math.floor((right + left) / 2)];
	var i = left;
	var j = right;

	while (i <= j) {

		while (items[i] < pivot)
			i++;

		while (items[j] > pivot)
			j--;

		if (i <= j) {
			swap(items, i, j);
			swap(items2, i, j);
			applyToResult("Troca de linhas " + (i + 1) + " por " + (j + 1) + "</br></br>"
					+ "Resultado: </br>" + toTable(items2) + "</br></br>");
			i++;
			j--;
		}
	}

	return i;

}

function swap(items, firstIndex, secondIndex){

	var temp = items[firstIndex];
	items[firstIndex] = items[secondIndex];
	items[secondIndex] = temp;

}

function applyExpressionToRow(res, i, iNonZero, expr){

	var y = res[0].length;
	var j = 0;
	var ev;

	for(;j < y;j++)
		if(res[i][j] || j == y - 1){
			ev = eval(expr);
			// GAMBIARRA FEDORENTA com isNaN, que resolve o problema de divisoes por zero e simplifica a vida :-) BJS
			res[i][j] = isNaN(ev) ? res[i][j] : ev;
		}


	applyToResult("~ L" + (i + 1) + " = "
			+ expr.replace("res[i][j]", "L" + (i + 1)).replace("res[iNonZero][j]", "L" + (iNonZero + 1)) + "</br></br>"
			+ "Resultado: </br>" + toTable(res) + "</br></br>");

	return res;

}

function totalFromRow(A, i){

	var t = 0;
	var l = 0;
	var x = A.length;

	for (; l < x; l++)
		t += A[i][l];

	return t;

}

function findNonZero(A, i, j, up){

	var x = A.length;
	var nonZero = null;
	if(up){
		for(--i;i >= 0;i--){
			if (A[i][j] != 0){
				nonZero = i;
				break;
			}
		}
				
	}else{
		for(++i;i < x;i++){
			if (A[i][j] != 0){
				nonZero = i;
				break;
			}
		}
	}

	return nonZero;

}

function switchLines(A, i, j, up){

	var x = A.length;
	var y = A[i].length - 1;
	var h;
	var j;
	var auxArr = [];

	if(up){
		for(h = i - 1;h >= 0;h--){
			if(A[h][j] != 0 && A[i][h] != 0){
				swap(A, h, i);
				break;
			}
		}				
	}else{
		for(h = i + 1;h < x;h++){
			if(A[h][j] != 0 && A[i][h] != 0){
				swap(A, h, i);
				break;
			}
		}
	}

	if(h != -1 && h != x)
		applyToResult("Troca de linhas " + (i + 1) + " por " + (h + 1) + "</br></br>"
					+ "Resultado: </br>" + toTable(A) + "</br></br>");
	
	return A;

}

function GCF(a, b){

	if (b == 0) return a;
	else return GCF (b, a % b);

}

function LCM(a, b){

	return Math.abs(a * b) / GCF(a, b);

}

function calcResult(){

	clearResult();

	var counter = 0;
	var operation = "";
	var matrixes = domToArray();

	while(counter < howMany){
		
		var matrHowmanyOpts = parseInt(document.getElementById("mat-" + counter + "-howmany-opts").value);
		var matrOptIndex = 0;

		while(matrOptIndex < matrHowmanyOpts){
			switch(document.getElementById("mat-" + counter + "-opt-" + matrOptIndex).value){
				case "invert": matrixes[counter] = invert(matrixes[counter]);
					if(matrixes[counter] === false){
						alert("Impossivel realizar inversao de matriz dada");
						return;
					}
					break;
				case "transpose": matrixes[counter] = transpose(matrixes[counter]);
					break;
				case "scale": var scaleBy = eval(getOperationArg(counter, matrOptIndex));
					matrixes[counter] = scale(matrixes[counter], scaleBy);
					break;
				case "power": var toThePower = parseInt(getOperationArg(counter, matrOptIndex));
					matrixes[counter] = power(matrixes[counter], toThePower);
					break;
				case "gaussJordanElimination": matrixes[counter] = gaussJordanElimination(matrixes[counter]);
					applyToResult("Resultado final: </br>");
					break;
				case "determine": matrixes[counter] = determine(matrixes[counter]);
					break;
			}
			matrOptIndex++;
		}
		counter++;
	}

	counter = 0;
	var res = matrixes[0];

	while(counter < howMany - 1){
		switch(document.getElementById("operation" + counter).value){
			case "sum": res = sum(res,matrixes[counter+1]); 
				break;
			case "subtract": res = subtract(res,matrixes[counter+1]); 
				break;
			case "multiply": res = multiply(res,matrixes[counter+1]); 
				break;
		}
		counter++;
	}

	showResult(res);

}

function getOperationArg(matrIndex, matrOptIndex){

	return document.getElementById("mat-" + matrIndex + "-opt-" + matrOptIndex + "-textfield-field").value;

}

function showResult(result){

	//if (document.getElementById("resultado").innerHTML != "") return;

	var res;

	if (typeof result === "number") res = result;
	else
		res = toTable(result);
	applyToResult(res);

}

function toTable(result){
	var x = result.length;
	var y = result[0].length;
	var i = 0;
	var j;
	var matrixStr = "<table width='" + y * 30 + "'>";
	for(;i < x;i++){
		matrixStr += "<tr>";
		for(j = 0;j < y;j++)
			matrixStr += "<td>" + result[i][j] + "</td>";
		matrixStr += "</tr>";
	}
	matrixStr += "</table>";
	return matrixStr;
}

function applyToResult(result){

	document.getElementById("resultado").innerHTML += result;

}


function clearResult(){

	document.getElementById("resultado").innerHTML = "";

}

</script>
<style>
#conteudo { position: relative; }
#matrizes { width:33.3%; position: absolute; float:left }
#igualdade { width:33.3%; position: absolute; top: 100px; left: 350px; text-align:center; }
#resultado { width:45%; position: absolute; top: 80px; right: 0px }
</style>
</head>

<body>

<div id="principal">

<div id="menu">

Quantas matrizes voc&ecirc; deseja?

<input type="text" id="quantas-matrizes" >

<button onclick="buildContainers()">Ok</button>
</div>

<div id="conteudo">
<div id="matrizes"></div>
<div id="igualdade"><button onclick="calcResult()">&#61;</button></div>
<div id="resultado"></div>
</div>

</div>

</body>

</html>
